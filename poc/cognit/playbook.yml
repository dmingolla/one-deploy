---
- name: Install POC Cognit on frontend
  hosts: frontend
  gather_facts: true
  vars:
    cognit_packages:
      - opennebula-cognit-frontend
      - opennebula-cognit-optimizer
      - opennebula-cognit-devices-estimated-load
    cognit_venv_path: "/usr/share/one/cognit-frontend/python-venv"
    cognit_requirements: "{{ playbook_dir }}/cognit_deb_requirements.txt"
  tasks:
    # --- Python venv setup (before deb packages so services can start) ---

    - name: Install git (needed for pyoneai from GitHub)
      ansible.builtin.apt:
        name: [git]
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure GitHub SSH host key is trusted
      ansible.builtin.known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com 2>/dev/null') }}"
        state: present

    - name: Install uv
      ansible.builtin.shell:
        cmd: curl -LsSf https://astral.sh/uv/install.sh | sh
        creates: /root/.local/bin/uv

    - name: Create Python virtualenv with uv
      ansible.builtin.shell:
        cmd: /root/.local/bin/uv venv {{ cognit_venv_path }}
        creates: "{{ cognit_venv_path }}/bin/python"

    - name: Copy locked requirements to target
      ansible.builtin.copy:
        src: "{{ cognit_requirements }}"
        dest: /tmp/cognit-requirements.lock
        mode: "0644"

    - name: Rewrite git URLs to use token auth (when no SSH agent)
      ansible.builtin.replace:
        path: /tmp/cognit-requirements.lock
        regexp: 'git\+ssh://git@github\.com/'
        replace: 'git+https://x-access-token:{{ github_token }}@github.com/'
      when: github_token is defined and github_token | length > 0
      no_log: true

    - name: Install locked requirements with uv
      ansible.builtin.shell:
        cmd: /root/.local/bin/uv pip install --python {{ cognit_venv_path }}/bin/python -r /tmp/cognit-requirements.lock

    # --- Cognit apt packages ---

    - name: Install POC Cognit packages
      ansible.builtin.apt:
        name: "{{ cognit_packages }}"
        state: present
      when: ansible_os_family == "Debian"

    # --- Enable and start Cognit services ---

    - name: Enable and start Cognit services
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - opennebula-cognit-frontend
        - opennebula-cognit-optimizer
        - opennebula-cognit-devices-estimated-load

    # --- Replace default marketplaces with Cognit marketplace ---

    - name: Get existing marketplaces
      ansible.builtin.command:
        cmd: onemarket list -l ID --no-header
      register: existing_markets
      changed_when: false
      become: true
      become_user: oneadmin

    - name: Disable default marketplaces (removes any apps)
      ansible.builtin.command:
        cmd: "onemarket disable {{ item }}"
      loop: "{{ existing_markets.stdout_lines | map('trim') | list }}"
      when: existing_markets.stdout_lines | length > 0
      failed_when: false
      become: true
      become_user: oneadmin

    - name: Delete default marketplaces
      ansible.builtin.command:
        cmd: "onemarket delete {{ item }}"
      loop: "{{ existing_markets.stdout_lines | map('trim') | list }}"
      when: existing_markets.stdout_lines | length > 0
      become: true
      become_user: oneadmin

    - name: Copy Cognit marketplace template
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/cognit_marketplace.tmpl"
        dest: /tmp/cognit_marketplace.tmpl
        mode: "0644"

    - name: Check if Cognit marketplace already exists
      ansible.builtin.shell:
        cmd: onemarket list --no-header | grep -q "Cognit Marketplace"
      register: cognit_market_check
      changed_when: false
      failed_when: false
      become: true
      become_user: oneadmin

    - name: Create Cognit marketplace
      ansible.builtin.command:
        cmd: onemarket create /tmp/cognit_marketplace.tmpl
      when: cognit_market_check.rc != 0
      become: true
      become_user: oneadmin

    # --- Install geocoder gem (needed by geo-carbon hook) ---

    - name: Install geocoder Ruby gem into OpenNebula gem path
      ansible.builtin.command:
        cmd: gem install geocoder -v 1.8.6 --install-dir /usr/share/one/gems --no-document

    # --- Register the geo-carbon hook ---

    - name: Create geo-carbon-hook
      ansible.builtin.command:
        cmd: onehook create /usr/share/one/geo_carbon_hook.tmpl
      become: true
      become_user: oneadmin
