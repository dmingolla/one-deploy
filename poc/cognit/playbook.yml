---
- name: Install POC Cognit on frontend
  hosts: frontend
  gather_facts: true
  vars:
    cognit_packages:
      - opennebula-cognit-frontend
      - opennebula-cognit-optimizer
      - opennebula-cognit-devices-estimated-load
    cognit_venv_path: "/usr/share/one/cognit-frontend/python-venv"
    cognit_requirements: "{{ playbook_dir }}/cognit_deb_requirements.txt"
  tasks:
    # --- Python venv setup (before deb packages so services can start) ---

    - name: Install git (needed for pyoneai from GitHub)
      ansible.builtin.apt:
        name: [git]
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure GitHub SSH host key is trusted
      ansible.builtin.known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com 2>/dev/null') }}"
        state: present

    - name: Install uv
      ansible.builtin.shell:
        cmd: curl -LsSf https://astral.sh/uv/install.sh | sh
        creates: /root/.local/bin/uv

    - name: Create Python virtualenv with uv
      ansible.builtin.shell:
        cmd: /root/.local/bin/uv venv {{ cognit_venv_path }}
        creates: "{{ cognit_venv_path }}/bin/python"

    - name: Copy locked requirements to target
      ansible.builtin.copy:
        src: "{{ cognit_requirements }}"
        dest: /tmp/cognit-requirements.lock
        mode: "0644"

    - name: Rewrite git URLs to use token auth (when no SSH agent)
      ansible.builtin.replace:
        path: /tmp/cognit-requirements.lock
        regexp: 'git\+ssh://git@github\.com/'
        replace: 'git+https://x-access-token:{{ github_token }}@github.com/'
      when: github_token is defined and github_token | length > 0
      no_log: true

    - name: Install locked requirements with uv
      ansible.builtin.shell:
        cmd: /root/.local/bin/uv pip install --python {{ cognit_venv_path }}/bin/python -r /tmp/cognit-requirements.lock

    # --- Cognit apt packages ---

    - name: Install POC Cognit packages
      ansible.builtin.apt:
        name: "{{ cognit_packages }}"
        state: present
      when: ansible_os_family == "Debian"

    # --- Enable and start Cognit services ---

    - name: Enable and start Cognit services
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - opennebula-cognit-frontend
        - opennebula-cognit-optimizer
        - opennebula-cognit-devices-estimated-load

    # --- Replace default marketplaces with Cognit marketplace ---

    - name: Get existing marketplaces
      ansible.builtin.command:
        cmd: onemarket list -l ID --no-header
      register: existing_markets
      changed_when: false
      become: true
      become_user: oneadmin

    - name: Disable default marketplaces (removes any apps)
      ansible.builtin.command:
        cmd: "onemarket disable {{ item }}"
      loop: "{{ existing_markets.stdout_lines | map('trim') | list }}"
      when: existing_markets.stdout_lines | length > 0
      failed_when: false
      become: true
      become_user: oneadmin

    - name: Delete default marketplaces
      ansible.builtin.command:
        cmd: "onemarket delete {{ item }}"
      loop: "{{ existing_markets.stdout_lines | map('trim') | list }}"
      when: existing_markets.stdout_lines | length > 0
      become: true
      become_user: oneadmin

    - name: Copy Cognit marketplace template
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/cognit_marketplace.tmpl"
        dest: /tmp/cognit_marketplace.tmpl
        mode: "0644"

    - name: Check if Cognit marketplace already exists
      ansible.builtin.shell:
        cmd: onemarket list --no-header | grep -q "Cognit Marketplace"
      register: cognit_market_check
      changed_when: false
      failed_when: false
      become: true
      become_user: oneadmin

    - name: Create Cognit marketplace
      ansible.builtin.command:
        cmd: onemarket create /tmp/cognit_marketplace.tmpl
      when: cognit_market_check.rc != 0
      become: true
      become_user: oneadmin

    # --- Install geocoder gem (needed by geo-carbon hook) ---

    - name: Install geocoder Ruby gem into OpenNebula gem path
      ansible.builtin.command:
        cmd: gem install geocoder -v 1.8.6 --install-dir /usr/share/one/gems --no-document

    # --- Register the geo-carbon hook ---

    - name: Create geo-carbon-hook
      ansible.builtin.command:
        cmd: onehook create /usr/share/one/geo_carbon_hook.tmpl
      become: true
      become_user: oneadmin

    # --- Fix: remove stale terraform that shadows the opennebula-form one ---

    - name: Remove stale /usr/local/bin/terraform (opennebula-form ships /usr/bin/terraform)
      ansible.builtin.file:
        path: /usr/local/bin/terraform
        state: absent
      when: ansible_os_family == "Debian"

    # --- Fix: patch KVM monitoring bug (info_each discards super return value) ---

    - name: Patch kvm.rb info_each to return super result instead of nil
      ansible.builtin.replace:
        path: /var/lib/one/remotes/im/lib/kvm.rb
        regexp: '(\s+)def info_each\(do_process\)\n(\s+)super\(do_process\)\n(\s+)vms_power\n(\s+)end'
        replace: '\1def info_each(do_process)\n\2result = super(do_process)\n\3vms_power\n\3result\n\4end'
      register: kvm_patch

    - name: Sync patched remotes to all hosts
      ansible.builtin.command:
        cmd: onehost sync --force
      become: true
      become_user: oneadmin
      when: kvm_patch.changed

    # --- Deploy custom Cognit OnPrem driver for OneForm ---

    - name: Deploy Cognit onprem driver to OneForm external directory
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/drivers/cognit_onprem/"
        dest: /var/lib/one/oneform/drivers/cognit/cognit_onprem/
        owner: oneadmin
        group: oneadmin
        mode: "0755"
        directory_mode: "0755"

    - name: Enable and restart OneForm server
      ansible.builtin.service:
        name: opennebula-form
        enabled: true
        state: restarted

    - name: Wait for OneForm API to be ready
      ansible.builtin.uri:
        url: http://127.0.0.1:13013
        status_code: [200, 401]
      register: oneform_health
      retries: 10
      delay: 3
      until: oneform_health is not failed

    # --- Provision edge cluster via OneForm ---

    - when: edge_host_ips is defined and edge_host_ips | length > 0
      block:
        - name: Read oneadmin public SSH key
          ansible.builtin.slurp:
            src: /var/lib/one/.ssh/id_rsa.pub
          register: oneadmin_pubkey

        - name: Authorize oneadmin SSH key for root@localhost (needed by OneForm Ansible)
          ansible.builtin.authorized_key:
            user: root
            key: "{{ oneadmin_pubkey.content | b64decode }}"

        - name: Distribute oneadmin SSH key to edge hosts
          ansible.builtin.authorized_key:
            user: root
            key: "{{ oneadmin_pubkey.content | b64decode }}"
          delegate_to: "{{ item }}"
          loop: "{{ edge_host_ips }}"

        - name: Create Cognit OnPrem provider
          ansible.builtin.command:
            cmd: oneprovider create cognit_onprem
          become: true
          become_user: oneadmin
          register: provider_result

        - name: Extract provider ID
          ansible.builtin.set_fact:
            cognit_provider_id: "{{ provider_result.stdout | regex_search('ID:\\s*(\\d+)', '\\1') | first }}"

        - name: Render provision inputs JSON
          ansible.builtin.copy:
            dest: /tmp/cognit_provision_inputs.json
            mode: "0644"
            content: |
              {
                "user_inputs_values": {
                  "oneform_onprem_hosts": {{ edge_host_ips | to_json }},
                  "phydev_name": "eth0",
                  "network_address": "{{ vn.admin_net.template.NETWORK_ADDRESS | default('172.20.0.0') }}",
                  "network_mask": "{{ vn.admin_net.template.NETWORK_MASK | default('255.255.255.0') }}",
                  "gateway": "{{ vn.admin_net.template.GATEWAY | default('172.20.0.1') }}",
                  "dns": "{{ vn.admin_net.template.DNS | default('1.1.1.1') }}",
                  "ip": "{{ vn.admin_net.template.AR.IP | default('172.20.0.100') }}",
                  "size": {{ vn.admin_net.template.AR.SIZE | default(48) }}
                }
              }

        - name: Create edge cluster provision
          ansible.builtin.command:
            cmd: >-
              oneprovision create cognit_onprem
              -p {{ cognit_provider_id }}
              -d ssh_cluster
              /tmp/cognit_provision_inputs.json
          become: true
          become_user: oneadmin
          register: provision_result

        - name: Show provision result
          ansible.builtin.debug:
            msg: "Edge cluster provision created: {{ provision_result.stdout }}"
