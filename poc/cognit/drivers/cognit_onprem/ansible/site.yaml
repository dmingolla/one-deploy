---
- name: Check hosts connectivity
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for hosts to be up
      ansible.builtin.wait_for_connection:
        timeout: 300
    - name: Wait for hosts to be reachable through SSH
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        timeout: 60
  tags: always

# ------------------------------------------------------------------------------
# Internal APT repo (dev builds not on public downloads.opennebula.io)
# repos_enabled must EXCLUDE 'opennebula' so the repository role doesn't
# overwrite our custom source list; then we write it ourselves and set the
# opennebula_repo fact so the cache update still triggers.
# ------------------------------------------------------------------------------
- name: Configure internal OpenNebula APT repo
  hosts: all
  gather_facts: true
  tasks:
    - name: Exclude opennebula from repos_enabled
      ansible.builtin.set_fact:
        repos_enabled: [ceph, frr, grafana]

    - name: Add internal OpenNebula APT repo
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/opennebula.list
        content: "deb [trusted=yes] http://5.2.88.196/repo/ {{ ansible_distribution_release }} poc-cognit\n"
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Set opennebula_repo fact so cache update still triggers
      ansible.builtin.set_fact:
        opennebula_repo:
          changed: true
          dest: /etc/apt/sources.list.d/opennebula.list
  tags: always

# ------------------------------------------------------------------------------
# One-deploy playbooks
# ------------------------------------------------------------------------------
- ansible.builtin.import_playbook: opennebula.deploy.pre

- name: Ensure NFS datastore target directories exist
  hosts: frontend
  become: true
  become_user: oneadmin
  become_method: sudo
  gather_facts: false
  tasks:
    - name: Create datastore target directories on the NFS share
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: 9869
        group: 9869
        mode: "0755"
      loop: "{{ _targets }}"
      delegate_to: "{{ (groups['frontend']|default([])|first) | default(groups['all']|first) }}"
      vars:
        _targets: >-
          {{
            ds.config | default({})
            | dict2items | map(attribute='value') | map('dict2items')
            | flatten
            | selectattr('value.symlink.src', 'defined')
            | map(attribute='value.symlink.src')
            | list
          }}
      when:
        - ds is defined
        - ds.mode | default('') == 'generic'
  tags: always

- ansible.builtin.import_playbook: opennebula.deploy.site

# ------------------------------------------------------------------------------
# Cognit edge-host customizations (add tasks here as needed)
# ------------------------------------------------------------------------------
# - name: Install Cognit edge software
#   hosts: node
#   tasks:
#     - name: Example - install nginx
#       ansible.builtin.apt:
#         name: nginx
#         state: present
#         update_cache: true
#   tags: always
